<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Orange Store - Repuestos</title>
  <link rel="icon" href="logopeq.png" type="image/png">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">

  <style>
    body {
      margin:0;
      font-family:'Poppins',sans-serif;
      background:linear-gradient(135deg,#fff7ed,#ffe5d0);
      color:#1f2937;
      min-height:100vh;
      display:flex;
      flex-direction:column;
    }

    header {
      background:linear-gradient(90deg,#f97316,#ea580c);
      color:#fff;
      padding:12px 20px;
      display:flex;
      align-items:center;
      gap:10px;
      position:sticky;
      top:0;
      z-index:1000;
      box-shadow:0 4px 12px rgba(0,0,0,0.15);
    }
    header img { height:40px; cursor:pointer; }
    header h1 { font-size:20px; margin:0; font-weight:600; }

    .rate-bar {
      text-align:center;
      margin:10px 0;
    }
    .rate-bar label {
      font-weight:600;
      color:#ea580c;
      margin-right:6px;
    }
    .rate-bar input {
      padding:6px 10px;
      border:1px solid #ccc;
      border-radius:6px;
      max-width:100px;
    }

    .search-area {
      text-align:center;
      margin:14px;
    }
    .search-area input {
      width:min(500px,90%);
      padding:10px 14px;
      border-radius:999px;
      border:1px solid #ddd;
      font-size:15px;
      outline:none;
      box-shadow:0 2px 6px rgba(0,0,0,0.08);
    }

    .filters {
      display:flex;
      gap:10px;
      justify-content:center;
      flex-wrap:wrap;
      margin-bottom:16px;
    }
    .filter-btn {
      border:2px solid #f97316;
      background:#fff;
      color:#f97316;
      padding:6px 14px;
      border-radius:999px;
      font-weight:600;
      cursor:pointer;
      font-size:14px;
      transition:all .2s;
    }
    .filter-btn.active,
    .filter-btn:hover {
      background:linear-gradient(90deg,#f97316,#ea580c);
      color:#fff;
    }

    .grid {
      max-width:1100px;
      margin:0 auto;
      padding:0 14px 40px;
      width:100%;
    }

    .card {
      background:#fff;
      border-radius:14px;
      margin-bottom:18px;
      box-shadow:0 4px 12px rgba(0,0,0,0.08);
      overflow:hidden;
    }
    .card-header {
      background:#ffedd5;
      padding:12px 16px;
      font-weight:600;
      color:#ea580c;
    }
    table {
      width:100%;
      border-collapse:collapse;
    }
    th,td {
      padding:10px 12px;
      border-bottom:1px solid #f1f1f1;
      font-size:14px;
    }
    th {
      background:#fafafa;
      text-align:left;
      color:#374151;
    }
    td { color:#222; }

    .spinner {
      display:flex;
      align-items:center;
      justify-content:center;
      min-height:200px;
    }
    .spinner div {
      width:40px;
      height:40px;
      border:4px solid #f97316;
      border-top-color:transparent;
      border-radius:50%;
      animation:spin 1s linear infinite;
    }
    @keyframes spin { to { transform:rotate(360deg); } }

    footer {
      text-align:center;
      padding:12px;
      font-size:13px;
      margin-top:auto;
      background:#fff7ed;
      color:#6b7280;
    }

    @media(max-width:720px){
      th,td{ font-size:13px; padding:8px; }
      header h1{ font-size:18px; }
    }
  </style>
</head>
<body>
  <header>
    <img src="logo.png" alt="Logo" onclick="window.location.href='index.html'">
    <h1>Orange Store - Repuestos</h1>
  </header>

  <div class="rate-bar">
    <label for="tasaInput">Tasa Bs/$:</label>
    <input type="number" id="tasaInput" step="0.01" placeholder="Ej: 36.00">
  </div>

  <div class="search-area">
    <input id="search" type="text" placeholder="Buscar repuesto o modelo...">
  </div>

  <div class="filters">
    <button class="filter-btn active" data-cat="all" onclick="filtrar('all',event)">Todos</button>
    <button class="filter-btn" data-cat="apple" onclick="filtrar('apple',event)">Apple</button>
    <button class="filter-btn" data-cat="samsung" onclick="filtrar('samsung',event)">Samsung</button>
  </div>

  <main class="grid" id="grid">
    <div class="spinner" id="spinner"><div></div></div>
  </main>

  <footer>
    Â© 2025 Orange Store. Todos los derechos reservados.
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2"></script>
  <script>
    const DATA_FILE = "repuestos.json";
    const FACTOR_PRECIO2 = 1.7;
    let productos = [];
    let fuse = null;
    let filtroActivo = "all";

    function escapeHtml(str=""){ return str.replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"}[m])); }
    function parsePrice(val){ return parseFloat((val||"").toString().replace(",",".").replace(/[^0-9.]/g,"")); }
    function formatMoney(n){ return isNaN(n)?"-":n.toFixed(2); }

    function detectarMarca(modelo=""){
      const m = modelo.toLowerCase();
      if(m.includes("iphone")||m.includes("apple")) return "apple";
      if(m.includes("samsung")||m.startsWith("a")||m.startsWith("j")||m.startsWith("s")) return "samsung";
      return "otros";
    }

    fetch(DATA_FILE)
      .then(r=>r.json())
      .then(data=>{
        productos = data || [];
        fuse = new Fuse(productos, {
          keys:["modelo","repuestos.nombre"],
          threshold:0.3,
          ignoreLocation:true,
          minMatchCharLength:2,
        });
        document.getElementById("spinner").style.display="none";
        mostrarProductos(productos);
      })
      .catch(err=>{
        console.error("Error cargando datos:",err);
        document.getElementById("grid").innerHTML="<p style='text-align:center;color:#b91c1c;'>Error cargando datos.</p>";
      });

    function mostrarProductos(lista){
      const grid=document.getElementById("grid");
      grid.innerHTML="";
      if(!lista||lista.length===0){
        grid.innerHTML="<p style='text-align:center;color:#666;'>No se encontraron resultados</p>";
        return;
      }

      const tasa = parseFloat(localStorage.getItem("tasaBS")) || 0;

      lista.forEach(item=>{
        const card=document.createElement("div");
        card.className="card";
        card.innerHTML=`<div class="card-header">${escapeHtml(item.modelo||"")}</div>`;
        const table=document.createElement("table");
        table.innerHTML=`<thead>
            <tr><th>Repuesto</th><th>Precio 1</th><th>Precio 2</th></tr>
          </thead><tbody></tbody>`;
        const tbody=table.querySelector("tbody");

        (item.repuestos||[]).forEach(r=>{
          const precio=parsePrice(r.precio);
          const precio2=precio*FACTOR_PRECIO2;
          const precio2bs = (!isNaN(precio2)&&tasa>0) ? ` (Bs ${formatMoney(precio2*tasa)})` : "";
          const tr=document.createElement("tr");
          tr.innerHTML=`<td>${escapeHtml(r.nombre||"")}</td>
                        <td>$${formatMoney(precio)}</td>
                        <td>$${formatMoney(precio2)}${precio2bs}</td>`;
          tbody.appendChild(tr);
        });

        card.appendChild(table);
        grid.appendChild(card);
      });
    }

    function filtrar(cat="all",ev){
      filtroActivo=cat;
      document.querySelectorAll(".filter-btn").forEach(b=>b.classList.remove("active"));
      if(ev&&ev.target) ev.target.classList.add("active");

      let lista=productos;
      const texto=document.getElementById("search").value.trim();
      if(texto!==""&&fuse){
        const resultados=fuse.search(texto);
        lista=resultados.map(r=>r.item);
      }
      if(cat!=="all"){
        lista=lista.filter(p=>detectarMarca(p.modelo)===cat);
      }
      mostrarProductos(lista);
    }

    let debounce;
    document.getElementById("search").addEventListener("input",()=>{
      clearTimeout(debounce);
      debounce=setTimeout(()=>filtrar(filtroActivo),200);
    });

    const tasaInput=document.getElementById("tasaInput");
    if(tasaInput){
      const guardada=localStorage.getItem("tasaBS");
      if(guardada) tasaInput.value=guardada;
      tasaInput.addEventListener("input",()=>{
        const val=parseFloat(tasaInput.value);
        if(!isNaN(val)&&val>0){
          localStorage.setItem("tasaBS",val);
          filtrar(filtroActivo);
        }
      });
    }
  </script>
</body>
</html>
